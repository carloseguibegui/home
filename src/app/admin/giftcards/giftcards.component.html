<div [@fadeContent] *ngIf="!loading" class="card shadow mb-4">
    <p-toast></p-toast>
    <p-toolbar>
        <ng-template #start>
            <p-button label="Nueva GiftCard" icon="pi pi-plus" (onClick)="newGiftcard()" />
        </ng-template>
    </p-toolbar>

    <p-table [value]="giftcards" [paginator]="true" [rows]="10" [rowHover]="true" [responsiveLayout]="'scroll'"
        sortField="nombre">
        <ng-template pTemplate="header">
            <tr>
                <th pSortableColumn="nombre" style="min-width:16rem">
                    Nombre
                    <p-sortIcon field="nombre" />
                </th>
                <th pSortableColumn="esVisible" style="min-width:16rem">
                    Estado
                    <p-sortIcon field="esVisible" />
                </th>
                <th style="min-width:16rem">Acciones</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-giftcard>
            <tr>
                <td>{{ giftcard.nombreGiftcard }}</td>
                <td>
                    <p-tag [value]="giftcard.esVisible ? 'Activa' : 'Oculta'"
                        [severity]="giftcard.esVisible ? 'success' : 'danger'"></p-tag>
                </td>
                <td>
                    <p-button icon="pi pi-pencil" class="mr-2" (click)="editGiftcard(giftcard)" [rounded]="true"
                        [outlined]="true"></p-button>
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true"
                        (click)="deleteGiftcard(giftcard)"></p-button>
                    <!-- [disabled]="isGiftcardInvalida()" -->
                    <!-- Botón para generar imagen y compartir -->
                    <!-- <p-button label="Generar imagen para WhatsApp" icon="pi pi-image"
                        (onClick)="generarImagenGiftcard(giftcardSeleccionada)"></p-button> -->
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Diálogo de crear/editar -->
    <p-dialog [(visible)]="displayDialog" [style]="{ width: '750px' }" header="Nueva giftcard" [modal]="true"
        (onHide)="hideDialog()">
        <div class="p-fluid">
            <div class="">
                <label class="block font-bold mb-3" for="nombreCategoria">De</label>
                <input pInputText id="de" type="text" [(ngModel)]="giftcardSeleccionada.de" required autofocus fluid />
                <!-- <small class="text-danger" *ngIf="!giftcardSeleccionada.de">El
                    nombre es obligatorio.</small> -->
            </div>
            <div class="pt-4">
                <label class="block font-bold mb-3" for="nombreCategoria">Para</label>
                <input pInputText id="para" type="text" [(ngModel)]="giftcardSeleccionada.para" required fluid />
                <!-- <small class="text-danger" *ngIf="!giftcardSeleccionada.para">El
                    destinatario es obligatorio.</small> -->
            </div>
            <div class="pt-4">
                <label class="block font-bold mb-3" for="nombreCategoria">Vale por</label>
                <input pInputText id="valePor" type="text" [(ngModel)]="giftcardSeleccionada.valePor" required fluid />
                <!-- <small class="text-danger" *ngIf="!giftcardSeleccionada.valePor">El contenido es obligatorio.</small> -->
            </div>
            <div class="pt-4">
                <label class="block font-bold mb-3" for="fechaExpiracion">Fecha de expiración</label>
                <br>
                <p-datepicker dateFormat="dd/mm/yy" [(ngModel)]="giftcardSeleccionada.fechaExpiracion"
                    [iconDisplay]="'input'" [showIcon]="true" inputId="icondisplay" inputId="buttondisplay"
                    size="small" required/>
                <br>
                <!-- <small class="text-danger" *ngIf="!giftcardSeleccionada.fechaExpiracion">
                    La fecha de expiración es obligatoria. -->
                <!-- </small> -->
            </div>
            <div class="pt-4 estado-giftcard">
                <label class="block font-bold mb-3">Estado</label>
                <p-select [(ngModel)]="giftcardSeleccionada.esVisible" inputId="esVisible" [options]="estadosGiftcard"
                    name="esVisible" inputId="esVisible" optionLabel="estado" optionValue="value" optionLabel="estado"
                    placeholder="Seleccione un estado" fluid required/>
                <!-- <small class="text-danger" *ngIf="giftcardSeleccionada.esVisible == null">El estado es
                    obligatorio.</small> -->
            </div>
        </div>
        <ng-template #footer>
            <p-button [loading]="isLoading" label="Generar Imagen" icon="pi pi-image" (click)="generarImagenGiftcard()"
                [disabled]="isGiftcardInvalida()" />
            <p-button [loading]="isLoading" label="Cancelar" icon="pi pi-times" (click)="hideDialog()" />
            <p-button [loading]="isLoading" label="Guardar" icon="pi pi-check" (click)="saveGiftcard()"
                [disabled]="isGiftcardInvalida()" severity="success"disabled />
        </ng-template>
    </p-dialog>
    <!-- 
            <label class="mt-3">Icono</label>
            <div class="flex flex-wrap gap-2">
                <button *ngFor="let icon of iconosDisponibles" pButton type="button" [icon]="icon"
                    [class.p-button-success]="giftcardSeleccionada.icono === icon" (click)="onIconSelect(icon)">
                </button>
            </div>
            <small class="text-muted">O puedes subir una imagen personalizada:</small>
            <p-fileupload mode="basic" accept="image/*" [maxFileSize]="1000000" chooseLabel="Subir imagen"
                (onSelect)="onImageUpload($event)" [auto]="true"></p-fileupload>
            <img *ngIf="giftcardSeleccionada.imagen" [src]="giftcardSeleccionada.imagen"
                style="max-width: 64px; max-height: 64px;" class="mt-2" />
        </div> -->

    <!-- Confirmación de borrado -->
    <p-dialog [style]="{ width: '750px' }" header="Confirmar eliminación" [(visible)]="deleteDialogVisible"
        [closable]="!isLoading" [modal]="true" [closeOnEscape]="!isLoading">
        <div>
            ¿Seguro que deseas eliminar la giftcard <b>{{ giftcardSeleccionada.nombre }}</b>?
        </div>
        <ng-template #footer>
            <p-button label="Cancelar" (click)="onCancelDelete()" [loading]="isLoading"></p-button>
            <p-button label="Eliminar" (click)="onAcceptDelete()" [loading]="isLoading" severity="danger"></p-button>
        </ng-template>
    </p-dialog>

    <!-- Vista previa oculta de la giftcard -->
    <div #giftcardPreview
        style="width:550px; padding:15px; background:white; border-radius:16px;  text-align:center; position:absolute; left:-9999px; top:-9999px;">
        <img [src]="logoClienteUrl" style="width:200px; margin-bottom:12px;">
        <!-- <h2>{{ giftcardSeleccionada.codigo }}</h2> -->
        <p><b>De:</b> {{ giftcardSeleccionada.de }}</p>
        <p><b>Para:</b> {{ giftcardSeleccionada.para }}</p>
        <p><b>Vale por:</b> {{ giftcardSeleccionada.valePor }}</p>
        <!-- <img *ngIf="qrCodeDataUrl" [src]="qrCodeDataUrl" style="width:120px; margin:12px auto;"> -->
        <p>Válida hasta: {{ giftcardSeleccionada.fechaExpiracion | date }}</p>
    </div>
</div>