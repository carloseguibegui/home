<app-background [imageUrl]="backgroundImage"></app-background>

<!-- Spinner -->
<app-spinner [@fadeInOut] *ngIf="loading"></app-spinner>
<p-confirmDialog [style]="{ width: 'min(92vw, 460px)' }"></p-confirmDialog>
<p-dialog [(visible)]="cartDialogVisible" [modal]="true" [closable]="true" [draggable]="false" [resizable]="false"
        [styleClass]="clienteClass"
        [dismissableMask]="false" [closeOnEscape]="false" [style]="{ width: 'min(92vw, 520px)' }"
        header="Confirmar pedido">
        <div class="cart-dialog-content">
                @for (cartItem of cartItems; track cartItem.key) {
                <div class="cart-dialog-item">
                        <div class="cart-dialog-item-info">
                                <strong>{{ cartItem.nombre }}</strong>
                                <span>{{ cartItem.precio || 'precio a confirmar' }}</span>
                        </div>
                        <div class="cart-dialog-qty-controls">
                                <button type="button" class="cart-dialog-qty-btn"
                                        (click)="updateCartQuantityFromDialog(cartItem.key, -1)"
                                        aria-label="Restar una unidad">
                                        -
                                </button>
                                <span class="cart-dialog-qty">{{ cartItem.cantidad }}</span>
                                <button type="button" class="cart-dialog-qty-btn"
                                        (click)="updateCartQuantityFromDialog(cartItem.key, 1)"
                                        aria-label="Sumar una unidad">
                                        +
                                </button>
                        </div>
                </div>
                }

                <div class="cart-dialog-total">
                        <span>Total productos: {{ cartItemsCount }}</span>
                        <strong>Importe total: {{ cartTotalLabel }}</strong>
                </div>

                <div class="cart-dialog-actions">
                        <button type="button" class="cart-dialog-secondary" (click)="cartDialogVisible = false">
                                Seguir viendo
                        </button>
                        <button type="button" class="cart-dialog-primary" (click)="sendCartToWhatsapp()"
                                [disabled]="!cartItemsCount">
                                Enviar por WhatsApp
                        </button>
                </div>
        </div>
</p-dialog>

<!-- Contenido principal -->
<div [@fadeContent]>
        <div [ngClass]="clienteClass" class="carta-container" [style.--card-bg]="'url(' + cardImage + ')'">
                <section *ngIf="!loading" class="content fade-in" [class.fade]="true" [class.show]="visible">
                        <!-- Header -->
                        <app-header [cliente]="cliente" [src_path]="logoImage"></app-header>

                        <!-- Slider de categorías -->
                        <app-slider [categorias]="categorias" [cliente]="cliente" [categoriaActual]="categoria"
                                (categoriaSeleccionada)="onCategoriaSeleccionada($event)">
                        </app-slider>

                        <!-- Barra de búsqueda -->
                        <app-search-bar [item_placeholder]="item_placeholder" (search)="onSearch($event)">
                        </app-search-bar>

                        <!-- Contenedor de productos -->
                        <div class="container py-4">
                                <div class="row g-4 mt-3">
                                        @for (item of items; track item.idProducto || item.nombre) {
                                        <div class="col-md-4 px-4 text-center" id="cart-item">
                                                <div class="card shadow-sm border-3 rounded-5 overflow-hidden div-carta position-relative"
                                                        style="max-width: 400px;">
                                                        <div class="blurred-load text-center position-relative"
                                                                (click)="openLightbox(item.imagen)"
                                                                [style.backgroundImage]="'url(' + item.small_imagen + ')'">
                                                                <img [src]="item.imagen" [alt]="item.nombre"
                                                                        loading="lazy" decoding="async"
                                                                        class="img-fluid w-100 object-fit-cover"
                                                                        [srcset]="item.small_imagen + ' 320w, ' + item.imagen + ' 800w'"
                                                                        sizes="(max-width: 768px) 100vw, 400px"
                                                                        width="800" height="667"
                                                                        (error)="item.imagen = 'assets/placeholder.png'" />
                                                        </div>
                                                        <div class="blurred-img card-body text-center px-4 pb-4 position-relative"
                                                                id="cuerpo-card">
                                                                <div id="card-nombre" class="pb-2 px-1">
                                                                        <div class="card-title fw-bold text-uppercase">
                                                                                <span
                                                                                        class="card-title-text">{{item.nombre}}</span>
                                                                                @if(item.isVegan) {
                                                                                <button type="button"
                                                                                        class="icon-info-button"
                                                                                        aria-label="Información producto vegano"
                                                                                        title="Producto vegano"
                                                                                        (click)="showVeganInfo($event)">
                                                                                        <svg xmlns="http://www.w3.org/2000/svg"
                                                                                                width="23"
                                                                                                viewBox="0 0 24 24"
                                                                                                fill="#1E382D">
                                                                                                <g fill="none"
                                                                                                        stroke="#1E382D"
                                                                                                        stroke-linecap="round"
                                                                                                        stroke-linejoin="round"
                                                                                                        stroke-width="2">
                                                                                                        <path
                                                                                                                d="M2 2a26.6 26.6 0 0 1 10 20c.9-6.82 1.5-9.5 4-14m0 0c4 0 6-2 6-6c-4 0-6 2-6 6" />
                                                                                                        <path
                                                                                                                d="M17.41 3.6a10 10 0 1 0 3 3" />
                                                                                                </g>
                                                                                        </svg>
                                                                                </button>
                                                                                }
                                                                                @if (item.isGlutenFree) {
                                                                                <button type="button"
                                                                                        class="icon-info-button"
                                                                                        aria-label="Información producto sin gluten"
                                                                                        title="Producto sin gluten"
                                                                                        (click)="showGlutenFreeInfo($event)">
                                                                                        <svg class="gluten-free-icon"
                                                                                                xmlns="http://www.w3.org/2000/svg"
                                                                                                viewBox="0 0 48 48"
                                                                                                aria-hidden="true"
                                                                                                role="img"
                                                                                                focusable="false">
                                                                                                <path fill-rule="evenodd"
                                                                                                        d="M44 24c0 11.046-8.954 20-20 20S4 35.046 4 24S12.954 4 24 4s20 8.954 20 20m-7.999 13.416A17.933 17.933 0 0 1 24 42c-9.941 0-18-8.059-18-18c0-4.738 1.83-9.048 4.823-12.263l3.97 3.97a1 1 0 0 0 1.414-1.414l-3.942-3.942A17.93 17.93 0 0 1 24 6c9.941 0 18 8.059 18 18c0 4.61-1.734 8.817-4.584 12.001l-8.545-8.544A5.726 5.726 0 0 0 31 23l-2.162.34A5.723 5.723 0 0 0 25 25.766v-2.923l1.162-.183A5.73 5.73 0 0 0 31 17l-2.162.34A5.723 5.723 0 0 0 25 19.766V18l.465-.465a5 5 0 0 0 0-7.07L24 9l-1.464 1.464a5 5 0 0 0 0 7.071L23 18v1.766a5.723 5.723 0 0 0-3.838-2.426L17 17a5.73 5.73 0 0 0 4.838 5.66l1.162.183v2.923a5.723 5.723 0 0 0-3.838-2.426L17 23a5.73 5.73 0 0 0 4.838 5.66l1.162.183v2.923a5.723 5.723 0 0 0-3.838-2.426L17 29a5.73 5.73 0 0 0 4.838 5.66l1.162.183V38h2v-3.547a1.78 1.78 0 0 0 1.162.207a5.727 5.727 0 0 0 4.15-2.935zm-7.907-7.907l-1.057-1.058a5.753 5.753 0 0 1-.875.209L25 28.843v2.923a5.727 5.727 0 0 1 3.094-2.257"
                                                                                                        clip-rule="evenodd" />
                                                                                        </svg>
                                                                                </button>
                                                                                }
                                                                                <div *ngIf="whatsappNumber"
                                                                                        class="cart-controls">
                                                                                        <button type="button"
                                                                                                class="share-whatsapp cart-action"
                                                                                                [class.is-hidden]="!getItemQuantityInCart(item)"
                                                                                                (click)="removeFromCart($event, item)"
                                                                                                aria-label="Quitar una unidad del carrito"
                                                                                                title="Quitar una unidad">
                                                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                                                        width="24"
                                                                                                        height="24"
                                                                                                        viewBox="0 0 24 24"
                                                                                                        fill="none">
                                                                                                        <path d="M5 12H19"
                                                                                                                stroke="currentColor"
                                                                                                                stroke-width="2.4"
                                                                                                                stroke-linecap="round" />
                                                                                                </svg>
                                                                                        </button>
                                                                                        <span class="cart-qty"
                                                                                                [class.is-hidden]="!getItemQuantityInCart(item)">
                                                                                                {{
                                                                                                getItemQuantityInCart(item)
                                                                                                }}
                                                                                        </span>
                                                                                        <button type="button"
                                                                                                class="share-whatsapp cart-action"
                                                                                                (click)="addToCart($event, item)"
                                                                                                aria-label="Agregar producto al carrito"
                                                                                                title="Agregar al carrito">
                                                                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                                                                        width="200"
                                                                                                        height="200"
                                                                                                        viewBox="0 0 48 48">
                                                                                                        <mask
                                                                                                                id="ipSAdd0">
                                                                                                                <g fill="none"
                                                                                                                        stroke-linejoin="round"
                                                                                                                        stroke-width="4">
                                                                                                                        <rect width="36"
                                                                                                                                height="36"
                                                                                                                                x="6"
                                                                                                                                y="6"
                                                                                                                                fill="#fff"
                                                                                                                                stroke="#fff"
                                                                                                                                rx="3" />
                                                                                                                        <path stroke="#000"
                                                                                                                                stroke-linecap="round"
                                                                                                                                d="M24 16v16m-8-8h16" />
                                                                                                                </g>
                                                                                                        </mask>
                                                                                                        <path fill="currentColor"
                                                                                                                d="M0 0h48v48H0z"
                                                                                                                mask="url(#ipSAdd0)" />
                                                                                                </svg>
                                                                                        </button>
                                                                                </div>
                                                                        </div>
                                                                </div>
                                                                <div id="card-descripcion">
                                                                        <span id="card-descripcion-span"
                                                                                aria-hidden="true">“</span>
                                                                        {{ item.descripcion }}.
                                                                </div>
                                                                @if (item._variantesEntries) {
                                                                @for (v of item._variantesEntries; track v[0]) {
                                                                <div class="btn rounded-3 d-block" id="boton-card">
                                                                        {{ v[0] }}: ${{ v[1] }}
                                                                </div>
                                                                }
                                                                }
                                                                @if (item.precio && !item.variantes) {
                                                                <div class="btn rounded-3 d-block" id="boton-card">
                                                                        ${{ item.precio }}
                                                                </div>
                                                                }
                                                                @if (item._extrasEntries) {
                                                                @for (e of item._extrasEntries; track e[0]) {
                                                                <div class="btn rounded-3 d-block extras"
                                                                        id="boton-card">
                                                                        {{ e[0] }}: ${{ e[1] }}
                                                                </div>
                                                                }
                                                                }
                                                        </div>
                                                </div>
                                        </div>
                                        }

                                        <button *ngIf="cartItemsCount" type="button" class="floating-cart"
                                                [class.with-scroll-top]="scrollToTopVisible"
                                                (click)="openCartConfirmation($event)"
                                                aria-label="Abrir carrito y confirmar pedido" title="Confirmar pedido">
                                                <span class="floating-cart-badge">{{ cartItemsCount }}</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"
                                                        viewBox="0 0 24 24" fill="none">
                                                        <path
                                                                d="M9 20c0 1.1-.9 2-2 2s-1.99-.9-1.99-2S5.9 18 7 18s2 .9 2 2zm8-2c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2s2-.9 2-2s-.9-2-2-2zm.396-5a2 2 0 0 0 1.952-1.566L21 5H7V4a2 2 0 0 0-2-2H3v2h2v11a2 2 0 0 0 2 2h12a2 2 0 0 0-2-2H7v-2h10.396z" />
                                                </svg>
                                        </button>

                                        <a [routerLink]="['/menuonline', cliente, 'carta']"
                                                class="btn button-add-cart checkout-button boton-volver">
                                                <span aria-hidden="true" style="padding-right: 7px;">↺</span>VOLVER
                                        </a>
                                </div>

                                <!-- Lightbox -->
                                <div class="lightbox" [class.show]="lightboxVisible"
                                        [class.hide]="!lightboxVisible && lightboxImage"
                                        (click)="closeLightbox($event)">
                                        <span *ngIf="zoomLevel === 1" class="lightbox-close"
                                                (click)="closeLightbox($event)" aria-label="Cerrar" tabindex="0"
                                                role="button"
                                                style="position: absolute; top: 24px; right: 32px; font-size: 2.5rem; color: #fff; z-index: 10; cursor: pointer; user-select: none;">
                                                &times;
                                        </span>
                                        <img class="lightbox-content" [src]="lightboxImage" (dblclick)="toggleZoom()"
                                                (touchstart)="handleDoubleTap($event); startDrag($event)"
                                                (mousedown)="startDrag($event)" (touchmove)="onDrag($event)"
                                                (mousemove)="onDrag($event)" (touchend)="endDrag()"
                                                (mouseup)="endDrag()" (mouseleave)="endDrag()"
                                                [style.transform]="zoomTransform"
                                                [style.cursor]="zoomLevel === 1 ? 'zoom-in' : 'grab'" />
                                </div>
                        </div>

                        <!-- Footer -->
                        <app-copyright [cliente]="nombreCliente" [marginBotClassDiv]="'mb-5'"></app-copyright>
                </section>
        </div>

        <!-- Scroll to top -->
        <app-scroll-to-top></app-scroll-to-top>
</div>
